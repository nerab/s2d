#!/usr/bin/env ruby

require 'bundler'
Bundler.require

def die(msg, code = 1)
  STDERR.puts(msg)
  exit(code)
end

device = 'iPhone' # TODO Add --device parameter
verbose = true    # TODO Add --verbose parameter

if device
  target = S2D::Configuration::Repository.instance.devices[device.to_sym]
  die("No device #{device} not configured") if target.nil?
else
  target = S2D::Configuration::Repository.instance.active_device
  die("No active device configured") if target.nil?
end

message = S2D::Message.new

if ARGV.size > 0
  message.body = ARGV.join(' ')
else
  puts 'Type your message and end with Control-D.' if verbose
  message.body = ARGF.read
end

if message.invalid?
  die('Invalid message') # TODO Add message.errors from ActiveSupport::Validations
else
  puts "Delivering your message via #{target.transport}" if verbose
  target.deliver(message)
end
